#include <Windows.h>
#include <iostream>
 
HANDLE Game_HANDLE;
HWND Game_HWND;
 
float Speed = 100.0f;
 
bool Running();
bool Relocation(bool State);
 
int main()
{
	if (Game_HWND = FindWindow(0, "Battlefield 4"))
	{
		DWORD Game_PID;
		GetWindowThreadProcessId(Game_HWND, &Game_PID);
		Game_HANDLE = OpenProcess(PROCESS_ALL_ACCESS, false, Game_PID);
	}
	else exit(404);
 
	while (!GetAsyncKeyState(VK_F7) && Running())
	{
		if (GetAsyncKeyState('C')) Relocation(true);
		else if (!GetAsyncKeyState('C')) Relocation(false);
		Sleep(1);
	}
 
	return 0;
}
 
bool Running()
{
	if (Game_HWND = FindWindow(0, "Battlefield 4")) return true;
	else return false;
}
 
bool Valid(DWORD_PTR In)
{
	if (In > 0x10000 && In < 0x100000000000) return true;
	else return false;
}
 
bool Relocation(bool State)
{
	unsigned char Inactive[] = { 0x80, 0x79, 0x58, 0x00 };
	unsigned char Active[] = { 0x80, 0x79, 0x58, 0x01 };
	unsigned char Status[4];
 
	if (State)
	{
		ReadProcessMemory(Game_HANDLE, PVOID(0x14100CC7A), &Status, sizeof(Status), NULL);
		if (!memcmp(Status, Inactive, sizeof(Inactive))) WriteProcessMemory(Game_HANDLE, PVOID(0x14100CC7A), &Active, sizeof(Active), NULL);
	}
	else if (!State)
	{
		ReadProcessMemory(Game_HANDLE, PVOID(0x14100CC7A), &Status, sizeof(Status), NULL);
		if (!memcmp(Status, Active, sizeof(Active))) WriteProcessMemory(Game_HANDLE, PVOID(0x14100CC7A), &Inactive, sizeof(Inactive), NULL);
	}
 
	DWORD_PTR Relocator_Offset[10];//Changed from 5 to 10 to prevent an exception from being thrown
	unsigned char Relocator, Relocating = 1, Relocated = 0;
	ReadProcessMemory(Game_HANDLE, PVOID(0x142670D80), &Relocator_Offset[0], sizeof(DWORD_PTR), NULL);
	if (!Valid(Relocator_Offset[0])) return false;
	ReadProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[0] + 0x60), &Relocator_Offset[1], sizeof(DWORD_PTR), NULL);
	if (!Valid(Relocator_Offset[1])) return false;
	ReadProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[1] + 0x540), &Relocator_Offset[2], sizeof(DWORD_PTR), NULL);
	if (!Valid(Relocator_Offset[2])) return false;
	ReadProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[2] + 0x14D0), &Relocator_Offset[3], sizeof(DWORD_PTR), NULL);
	if (!Valid(Relocator_Offset[3])) return false;
	ReadProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[3] + 0xD50), &Relocator_Offset[4], sizeof(DWORD_PTR), NULL);
	if (!Valid(Relocator_Offset[4])) return false;
	ReadProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[4] + 0x0), &Relocator_Offset[5], sizeof(DWORD_PTR), NULL);
	if (Relocator_Offset[5] != 5400624000) return false;
	ReadProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[4] + 0x58), &Relocator, sizeof(Relocator), NULL);
 
	if (State)
	{
		if (Relocator != 1) WriteProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[4] + 0x58), &Relocating, sizeof(Relocating), NULL);
		DWORD_PTR View_Offset[4];
		float View[2];
		ReadProcessMemory(Game_HANDLE, PVOID(0x1423B2EC8), &View_Offset[0], sizeof(DWORD_PTR), NULL);
		if (!Valid(View_Offset[0])) return false;
		ReadProcessMemory(Game_HANDLE, PVOID(View_Offset[0] + 0x1F0), &View_Offset[1], sizeof(DWORD_PTR), NULL);
		if (!Valid(View_Offset[1])) return false;
		ReadProcessMemory(Game_HANDLE, PVOID(View_Offset[1] + 0x170), &View_Offset[2], sizeof(DWORD_PTR), NULL);
		if (!Valid(View_Offset[2])) return false;
		ReadProcessMemory(Game_HANDLE, PVOID(View_Offset[2] + 0x10), &View_Offset[3], sizeof(DWORD_PTR), NULL);
		if (!Valid(View_Offset[3])) return false;
		ReadProcessMemory(Game_HANDLE, PVOID(View_Offset[3] + 0x14), &View, sizeof(View), NULL);
 
		float Corrected[3];
		Corrected[0] = (-sin(View[0]) * Speed);
		Corrected[1] = (View[1] * Speed);
		Corrected[2] = (cos(View[0]) * Speed);
 
		WriteProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[4] + 0x90), &Corrected, sizeof(Corrected), NULL);
	}
	else if (!State && Relocator != 0)
	{
		WriteProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[4] + 0x58), &Relocated, sizeof(Relocated), NULL);
		Sleep(50);
		WriteProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[4] + 0x58), &Relocating, sizeof(Relocating), NULL);
		Sleep(50);
		WriteProcessMemory(Game_HANDLE, PVOID(Relocator_Offset[4] + 0x58), &Relocated, sizeof(Relocated), NULL);
	}
 
	return true;
}
